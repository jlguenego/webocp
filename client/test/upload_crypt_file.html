<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Web OCP</title>
		<script src="../_ext/jquery-1.10.2.min.js"></script>
		<script src="../_ext/jquery-ui-1.10.3/ui/minified/jquery-ui.min.js"></script>
		<link rel="stylesheet" href="../_ext/jquery-ui-1.10.3/themes/base/minified/jquery-ui.min.css" />

		<!-- CRYPTO JS -->
		<script src="../_ext/sha1.js"></script>
		<script src="../_ext/aes.js"></script>
		<!-- END CRYPTO JS -->

		<!-- PROGRESSBAR -->
		<script src="../js/ocp/widget_progressbar.js"></script>
		<link rel="stylesheet" href="../js/ocp/theme/default/widget_progressbar.css" />
		<!-- END PROGRESSBAR -->

		<script src="../_ext/FileSaver.js"></script>
		<script src="../_ext/BlobBuilder.min.js"></script>
		<script src="../_ext/Blob.js"></script>

		<script src="../js/ocp_client.js"></script>
		<script src="../js/ocp_profile.js"></script>
		<script src="upload_crypt_file.js"></script>

		<style>
html, body {
	margin: 0px;
	padding: 0px;
	height: 100%;
}
		</style>
	</head>

	<body>
		<input type="text" id="server_uri" value="http://localhost" /><br/>
		<input type="text" id="secret_key" /><br/>
		<input type="file" id="file" name="file" /><button id="send">Send</button>
		<div id="progress" style="position: relative; width: 200px; height: 50px;"></div>
		<div id="upload_name"></div>
		<button id="retrieve">Retrieve</button>
		<div id="decrypted_content"></div>

		<script>
			var profiler = new ocp_profile();
			$(function() {
				// Check for the various File API support.
				if (!window.File || !window.FileReader || !window.FileList || !window.Blob) {
				  alert('The File APIs are not fully supported in this browser.');
				  return;
				}
			});

			function readBlob() {
				profiler.start();
				var secret_key = $('#secret_key').val();

				var file = $('#file').get(0).files[0];
				if (!file) {
					alert('no file');
					return;
				}
				var start = 0;
				var step = file.size;

				var ocp = new OCP();
				while (start < file.size) {
					var stop = start + step;
					var reader = new FileReader();

					// If we use onloadend, we need to check the readyState.
					reader.onload = (function(my_start, my_stop, my_step) {
						return function(evt) {
							if (evt.target.readyState == FileReader.DONE) { // DONE == 2
								profiler.report('read content');
								var content = evt.target.result;
								profiler.report('start str2hex');
								var hex = str2hex(content);
								profiler.report('end str2hex');

								profiler.report('start Hex to Word');
								var words = CryptoJS.enc.Hex.parse(hex);
								profiler.report('end Hex to Word');

								profiler.report('start encryption');
								var crypted_content = ocp.pcrypt(secret_key, words);
								profiler.report('end encryption');

								var filename = ocp.hash(crypted_content);
								$('#upload_name').html(filename);

								$.ajaxSetup({
									cache: false,
									scriptCharset: "utf-8"
								});

								var result = null;
								profiler.report('start upload');
								$.ajax({
									type: "POST",
									url: $('#server_uri').val() + '/webocp/server/test/endpoint/create_file_from_string.php',
									async: true,
							        xhr: function() {  // custom xhr
							            var myXhr = $.ajaxSettings.xhr();
							            if(myXhr.upload){ // check if upload property exists
							                myXhr.upload.addEventListener('progress', function(e) {
							                	on_progress(e, filename);
							                }, false); // for handling the progress of the upload
							            }
							            return myXhr;
							        },
									data: {
										filename: filename,
										content: crypted_content
									},
									success: function(data) {
										profiler.report('end upload');
										console.log(data);
										var output = $.parseJSON(data);
										if (output.error) {
											throw new OCPException('Server answered: ' + output.error);
										}
										if (output.result) {
											result = output.result;
										}
									},
									error: function(jqXHR, textStatus, errorThrown) {
										console.log('ajax_ls error');
										console.log('jqXHR=' + jqXHR + "\ntextStatus=" + textStatus + "\nerrorThrown=" + errorThrown);
									},
									statusCode: {
										404: function() {
											console.log("page not found");
										}
									}
								});
							}
						};
					})(start, stop, step);

					var blob = file.slice(start, stop);
					reader.readAsBinaryString(blob);
					start += step;
				}
			}

			$('#send').click(readBlob);

			$('#progress').ocp_progressbar();

			function on_progress(e, filename) {
				var total = e.total;
				var loaded = e.loaded;
				var percent = Math.round((loaded * 100) / total);
				$('#progress').ocp_progressbar('set_progress', percent);
			}

			$('#retrieve').click(function() {
				profiler.start();
				var filename = $('#upload_name').html();
				$.ajaxSetup({
					cache: false,
					scriptCharset: "utf-8"
				});

				var result = null;
				profiler.report('ask for file');
				$.ajax({
					type: "POST",
					url: $('#server_uri').val() + '/webocp/server/test/endpoint/retrieve_file.php',
					async: true,
			        xhr: function() {  // custom xhr
			            var myXhr = $.ajaxSettings.xhr();
			            if(myXhr.upload){ // check if upload property exists
			                myXhr.upload.addEventListener('progress', function(e) {
			                	on_progress(e, filename);
			                }, false); // for handling the progress of the upload
			            }
			            return myXhr;
			        },
					data: {
						filename: filename
					},
					success: function(data) {
						profiler.report('crypted file retrieved');
						console.log(data);

						var output = $.parseJSON(data);
						if (output.error) {
							throw new OCPException('Server answered: ' + output.error);
						}
						if (output.result) {
							result = output.result;
						}

						profiler.report('start encoding from Latin1 to Base64');
						var words = CryptoJS.enc.Latin1.parse(result.content);
						var b64 = CryptoJS.enc.Base64.stringify(words);
						profiler.report('end encoding from Latin1 to Base64');

						var secret_key = $('#secret_key').val();

						profiler.report('start decryption');
						var words = CryptoJS.AES.decrypt(b64, secret_key);
						profiler.report('end decryption');
						var d_content = words.toString();

						save_as(d_content, filename);
					},
					error: function(jqXHR, textStatus, errorThrown) {
						console.log('ajax_ls error');
						console.log('jqXHR=' + jqXHR + "\ntextStatus=" + textStatus + "\nerrorThrown=" + errorThrown);
					},
					statusCode: {
						404: function() {
							console.log("page not found");
						}
					}
				});
			});

			function hex2a(hex) {
			    var str = '';
			    for (var i = 0; i < hex.length; i += 2) {
			        str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
			    }
			    return str;
			}

			function str2ab(str) {
				var buf = new ArrayBuffer(str.length*2); // 2 bytes for each char
				var bufView = new Uint16Array(buf);
				for (var i=0, strLen=str.length; i<strLen; i++) {
					bufView[i] = str.charCodeAt(i);
				}
				return buf;
			}
		</script>
	</body>
</html>