<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<base href="../.." />
		<script src="_ext/jquery-1.10.2.min.js"></script>
		<script src="_ext/jquery-ui-1.10.3/ui/minified/jquery-ui.min.js"></script>
		<link rel="stylesheet" href="_ext/jquery-ui-1.10.3/themes/base/minified/jquery-ui.min.css" />

		<!-- PROGRESSBAR -->
		<script src="js/ocp/widget_progressbar.js"></script>
		<link rel="stylesheet" href="js/ocp/theme/default/widget_progressbar.css" />
		<!-- END PROGRESSBAR -->

		<!-- POOL VIEW -->
		<script src="js/ocp/widget_pool_view.js"></script>
		<link rel="stylesheet" href="js/ocp/theme/default/widget_pool_view.css" />
		<!-- END POOL VIEW -->

		<script src="_ext/FileSaver.js"></script>
		<script src="_ext/Blob.js"></script>

		<script src="js/ocp.js"></script>
		<script src="js/ocp_worker_misc.js"></script>
		<script src="js/ocp_worker_pool.js"></script>
	</head>

	<body>
		<div id="pool_view"></div>
		Serveur URL: <input type="text" id="server_uri" /><br/>
		Secret key: <input type="text" id="secret_key" value="toto" /><br/>
		Upload name: <input type="text" id="upload_name" style="width: 300px;"/><br/>
		<button id="retrieve">Retrieve</button>
		<div id="progress" class="progress" style="position: relative; width: 200px; height: 50px;"></div>

<!-- WORKER -->
		<script id="worker" type="text/js-worker">
importScripts(base_url + '/_ext/sha1.js');
importScripts(base_url + '/_ext/aes.js');
importScripts(base_url + '/_ext/WorkerFormData.js');

importScripts(base_url + '/js/ocp.js');
importScripts(base_url + '/js/ocp_utils.js');
importScripts(base_url + '/js/ocp_worker.js');
importScripts(base_url + '/js/ocp_crypto.js');
importScripts(base_url + '/js/ocp_file.js');
importScripts(base_url + '/js/ocp_worker_file.js');
importScripts(base_url + '/js/ocp_download.js');
		</script>
<!-- END WORKER -->

		<script>
$('.progress').ocp_progressbar();
$('#pool_view').ocp_pool_view();

var host_uri = window.location.href.replace('/webocp/client/test/web_worker/worker_retrieve_crypt_file.html', '');
$('#server_uri').val(host_uri);

$('#retrieve').click(function() {
	blocks = [];
	ocp.cfg.server_base_url = $('#server_uri').val();
	var filename = $('#upload_name').val();
	if (!filename) {
		alert('no file');
		return;
	}

	args = {
		filename: filename,
		secret_key: $('#secret_key').val(),
		progress_bar: $('#progress')
	}
	file_retrieve(args);
});

function file_retrieve(args) {
	var worker_url = ocp.worker_misc.getEmbeddedURL('worker');
	var tm = {
		total_task: 1, // download hat is the first task
		total_performed: 0
	};
	var pool = new ocp.worker_pool.Pool(10, worker_url);
	var filename = args.filename;
	var secret_key = args.secret_key;
	var progress_bar = args.progress_bar;
	var blocks = [];

	$('#pool_view').ocp_pool_view('attach', pool);

	var hat_args = {
		block_name: filename,
		server_uri: ocp.cfg.server_base_url,
		secret_key: secret_key
	};

	var hat_callback = function() {
		console.log(event.data);
		if (event.data.hat) {
			for (var i = 0; i < event.data.hat.block_nbr; i++) {
				create_task(event.data.hat, i);
			}
			pool.terminate(); // Nice
		}

		update_progress(event.data);
	};

	var task = new ocp.worker_pool.Task('hat', 'download_hat', hat_args, hat_callback);
	pool.addTask(task);

	function update_progress(obj) {
		if (tm.total_task <= 0) {
			progress_bar.ocp_progressbar('set_progress', 100);
			return;
		}
		if (obj.finish) {
			tm.total_performed++;
		}
		var progress =  Math.floor(tm.total_performed * 100 / tm.total_task);
		console.log('tm=');
		console.log(tm);
		progress_bar.ocp_progressbar('set_progress', progress);
	}

	function create_task(hat, i) {
		var task_args = {
			block_id: i,
			block_name: hat.summary[i],
			secret_key: secret_key,
			server_uri: ocp.cfg.server_base_url,
			block_size: hat.block_size,
			hat_name: filename
		};
		tm.total_task++;
		var task_callback = function(event) {
			update_progress(event.data);

			if (event.data.block_written) {
				blocks.push(event.data.block_id);

				console.log('pushed block_id: ' + event.data.block_id)
				console.log('blocks.length=' + blocks.length);
				console.log('hat.block_nbr=' + hat.block_nbr);
			}
			if (blocks.length == hat.block_nbr) {
				console.log('download_finalize');
				finalize();
			}
		}
		var task = new ocp.worker_pool.Task(i, 'download_block', task_args, task_callback);
		pool.addTask(task);
	}

	function finalize() {
		window.requestFileSystem  = window.requestFileSystem || window.webkitRequestFileSystem;
		window.requestFileSystem(window.TEMPORARY, 1024 * 1024 * 1024, function(filesystem) {
			filesystem.root.getFile(filename, {create: false}, function(fileEntry) {
				console.log(fileEntry);
				var url = fileEntry.toURL();
				console.log(url);
				var link = $('<a/>');
				link.attr('href', url).attr('download', '');
				console.log(link[0]);
				//link.html('xxx');
				$('body').append(link);
				link[0].click();
			}, errorHandler('getFile'));
		}, errorHandler('requestFileSystem'));
	}

	function errorHandler(tag) {
		return function(e) {
			console.log(tag + ' Error=');
			console.log(e);
		}
	}
}
		</script>
	</body>
</html>