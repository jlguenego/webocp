<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<base href="../.." />
		<title>Web OCP</title>
		<script src="_ext/jquery-1.10.2.min.js"></script>
		<script src="_ext/jquery-ui-1.10.3/ui/minified/jquery-ui.min.js"></script>
		<link rel="stylesheet" href="_ext/jquery-ui-1.10.3/themes/base/minified/jquery-ui.min.css" />

		<!-- PROGRESSBAR -->
		<script src="js/ocp/widget_progressbar.js"></script>
		<link rel="stylesheet" href="js/ocp/theme/default/widget_progressbar.css" />
		<!-- END PROGRESSBAR -->

		<script src="_ext/FileSaver.js"></script>
		<script src="_ext/Blob.js"></script>

		<script src="js/ocp.js"></script>
		<script src="js/ocp_worker.js"></script>
	</head>

	<body>
		Serveur URL: <input type="text" id="server_uri" value="http://localhost" /><br/>
		Secret key: <input type="text" id="secret_key" value="toto" /><br/>
		<input type="file" id="file" name="file" /><button id="send">Send</button>
		<div id="progress" style="position: relative; width: 200px; height: 50px;"></div>
		<div id="upload_name"></div>
		<button id="retrieve">Retrieve</button>

<!-- WORKER -->
		<script id="worker" type="text/js-worker">
importScripts(base_url + '/js/ocp.js');
importScripts(base_url + '/js/ocp_worker_utils.js');
importScripts(base_url + '/js/ocp_crypto.js');

ocp.worker_utils.init_console(this);

function run(event) {
    var task = event.data;
    switch(task.name) {
    	case 'upload_block':
    		upload_block(task.args);
    		break;
    }
}

this.addEventListener('message', ocp.worker_utils.run(this, run), false);

function upload_block(args) {
	var file = args.file;
	var blob = file.slice(args.cursor, args.cursor_next);
	var reader = new FileReader();
	reader.onload = function(evt) {
		if (evt.target.readyState == FileReader.DONE) { // DONE == 2
			var filename = process_block(evt.target.result);
			report({
				filename: filename,
				block_id: args.block_id
			});
		}
	};
	reader.readAsBinaryString(blob);
	console('update block');
}

function process_block(block_str) {
	console(block_str.substr(0, 10));
	var filename = 'xx';
	return filename;
}
		</script>
<!-- END WORKER -->

		<script>
$('#progress').ocp_progressbar();

$('#send').click(function() {
	var secret_key = $('#secret_key').val();
	var file = $('#file').get(0).files[0];
	if (!file) {
		alert('no file');
		return;
	}
	var url = ocp.worker.getEmbeddedURL('worker');
	var pool = new ocp.worker.Pool(10, url);
	setup_upload_task(file, pool);
});

function setup_upload_task(file, pool) {
	var cursor = 0;
	var block_size = 1 << 16;

	var block_id = 0;
	while (cursor < file.size) {
		var cursor_next = cursor + block_size;

		var args = {
			file: file,
			cursor: cursor,
			cursor_next: cursor_next,
			block_id: block_id
		};

		var callback_func = function(event) {
			console.log(event.data);
		};

		var task = new ocp.worker.Task(block_id, 'upload_block', args, callback_func);
		pool.addTask(task);

		cursor = cursor_next;
		block_id++;
	}
}
		</script>
	</body>
</html>