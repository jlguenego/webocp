<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<base href="../.." />
		<title>Web OCP</title>
		<script src="_ext/jquery-1.10.2.min.js"></script>
		<script src="_ext/jquery-ui-1.10.3/ui/minified/jquery-ui.min.js"></script>
		<link rel="stylesheet" href="_ext/jquery-ui-1.10.3/themes/base/minified/jquery-ui.min.css" />

		<!-- PROGRESSBAR -->
		<script src="js/ocp/widget_progressbar.js"></script>
		<link rel="stylesheet" href="js/ocp/theme/default/widget_progressbar.css" />
		<!-- END PROGRESSBAR -->

		<!-- POOL VIEW -->
		<script src="js/ocp/widget_pool_view.js"></script>
		<link rel="stylesheet" href="js/ocp/theme/default/widget_pool_view.css" />
		<!-- END POOL VIEW -->

		<script src="_ext/FileSaver.js"></script>
		<script src="_ext/Blob.js"></script>

		<script src="js/ocp.js"></script>
		<script src="js/ocp_worker_misc.js"></script>
		<script src="js/ocp_worker_pool.js"></script>
	</head>

	<body>
		<div id="pool_view"></div>
		Serveur URL: <input type="text" id="server_uri" value="http://localhost" /><br/>
		Secret key: <input type="text" id="secret_key" value="toto" /><br/>
		<input type="file" id="file" name="file" /><button id="send">Send</button>
		<div id="progress" style="position: relative; width: 200px; height: 50px;"></div>
		<div id="upload_name"></div>
		<button id="retrieve">Retrieve</button>

<!-- WORKER -->
		<script id="worker" type="text/js-worker">
importScripts(base_url + '/_ext/sha1.js');
importScripts(base_url + '/_ext/aes.js');

importScripts(base_url + '/js/ocp.js');
importScripts(base_url + '/js/ocp_utils.js');
importScripts(base_url + '/js/ocp_worker.js');
importScripts(base_url + '/js/ocp_crypto.js');

importScripts(base_url + '/_ext/WorkerFormData.js');

ocp.worker.init(this);

function run(event) {
    var task = event.data;
    switch(task.name) {
    	case 'upload_block':
    		upload_block(task.args);
    		return false;
    	case 'upload_hat_init':
    		upload_hat_init(task.args);
    		return false;
    	case 'upload_hat_push':
    		upload_hat_push(task.args);
    		return false;
    }
    return true;
}

this.addEventListener('message', ocp.worker.run(this, run), false);

function upload_hat_init(args) {
	console.log('upload hat init');
	this.upload_hat = {};
	this.upload_hat.block_nbr = Math.ceil(args.file.size / args.block_size);
	this.upload_hat.secret_key = args.secret_key;
	this.upload_hat.server_uri = args.server_uri;
	this.upload_hat.summary = [];
	console.log('block_nbr=' + this.upload_hat.block_nbr);
}

function upload_hat_push(args) {
	console.log('upload hat push');
	this.upload_hat.summary.push(args);

	if (this.upload_hat.summary.length == this.upload_hat.block_nbr) {
		console.log('ready to send the summary');
		var content = '';
		for (var i = 0; i < this.upload_hat.summary.length; i++) {
			var obj = this.upload_hat.summary[i];
			content += obj.block_id + '_' + obj.filename + "\n";
		}
		var filename = process_block(content, this.upload_hat.secret_key, this.upload_hat.server_uri);
		report({
			filename: filename
		});
	}
}

function upload_block(args) {
	var file = args.file;
	var blob = file.slice(args.cursor, args.cursor_next);
	var reader = new FileReader();
	reader.onload = function(evt) {
		if (evt.target.readyState == FileReader.DONE) { // DONE == 2
			var filename = process_block(evt.target.result, args.secret_key, args.server_uri);
			report({
				filename: filename,
				block_id: args.block_id
			});
		}
	};
	reader.readAsBinaryString(blob);
	console.log('update block');
}

function process_block(block_str, secret_key, server_uri) {
	// 1) crypt
	var crypted_block_str = ocp.crypto.pcrypt(secret_key, block_str);

	// 2) hash
	var filename = ocp.crypto.hash(crypted_block_str);

	// 3) upload
	upload_file(server_uri, filename, crypted_block_str, function() {
		finish: true
	});
	return filename;
}

function upload_file(url, filename, content, success_func) {
	var formData = new FormData();
	formData.append('filename', filename);
	var blob = new Blob([content], { type: "text/plain" });
	formData.append('content', blob);

	var xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function(){
		if (xhr.readyState == 4 && xhr.status == 200) { // on success
			var json_str = xhr.responseText;
			var json_obj = JSON.parse(json_str);
			console.log(json_obj);
			report({
				finish: true
			});
		}
	}
	xhr.open('POST', url, true);
	xhr.send(formData);
}
		</script>
<!-- END WORKER -->

		<script>
$('#progress').ocp_progressbar();
$('#pool_view').ocp_pool_view();

$('#send').click(function() {
	var secret_key = $('#secret_key').val();
	var file = $('#file').get(0).files[0];
	if (!file) {
		alert('no file');
		return;
	}
	var url = ocp.worker_misc.getEmbeddedURL('worker');
	setup_upload_task(file, url, secret_key);
});

var server_uri = $('#server_uri').val() + '/webocp/server/test/endpoint/create_file_from_string.php';
var total_task = 0;
var total_performed = 0;

function setup_upload_task(file, url, secret_key) {
	var pool = new ocp.worker_pool.Pool(10, url);
	$('#pool_view').ocp_pool_view('attach', pool);

	var cursor = 0;
	var block_size = 1 << 16;

	var hat_worker = get_hat_worker(url, file, block_size, secret_key);
	total_task++;

	var block_id = 0;
	while (cursor < file.size) {
		var cursor_next = cursor + block_size;

		var args = {
			file: file,
			cursor: cursor,
			cursor_next: cursor_next,
			block_id: block_id,
			secret_key: secret_key,
			server_uri: server_uri
		};

		var callback_func = function(event) {
			console.log(event.data);
			var progress = update_progress_from_task(event.data);
			$('#progress').ocp_progressbar('set_progress', progress);
			if (event.data.filename) {
				hat_worker.push(event.data);
			}
		};

		var task = new ocp.worker_pool.Task(block_id, 'upload_block', args, callback_func);
		pool.addTask(task);
		total_task++;

		cursor = cursor_next;
		block_id++;
	}
}

function update_progress_from_task(obj) {
	if (total_task <= 0) {
		return 100;
	}
	if (obj.finish) {
		total_performed++;
	}
	return Math.floor(total_performed * 100 / total_task);
}

function get_hat_worker(url, file, block_size, secret_key) {
	var hat_worker = new Worker(url);

	var hat_worker_callback = function() {
		if (event.data.console) {
			console.log('Thread[' + event.data.thread + ']-Task[' + event.data.task_name + '-' + event.data.task_id + ']: ' + event.data.console);
			return;
		}
		console.log(event.data);
		var progress = update_progress_from_task(event.data);
		$('#progress').ocp_progressbar('set_progress', progress);
		if (event.data.filename) {
			$('#upload_name').html(event.data.filename);
		}
	};
	hat_worker.addEventListener('message', hat_worker_callback, false);
	hat_worker.postMessage({
		name: 'set_name',
		args: 'hat'
	});
	hat_worker.postMessage({
		id: 'hat',
		name: 'upload_hat_init',
		args: {
			file: file,
			block_size: block_size,
			server_uri: server_uri,
			secret_key: secret_key
		}
	});

	hat_worker.push = function(data) {
		console.log('push');
		console.log(data);
		this.postMessage({
			id: 'hat',
			name: 'upload_hat_push',
			args: {
				filename: data.filename,
				block_id: data.block_id
			}
		});
	};
	return hat_worker;
}
		</script>
	</body>
</html>