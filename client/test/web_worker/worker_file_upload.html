<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<base href="../.." />
		<script src="_ext/jquery-1.10.2.min.js"></script>
		<script src="_ext/jquery-ui-1.10.3/ui/minified/jquery-ui.min.js"></script>
		<link rel="stylesheet" href="_ext/jquery-ui-1.10.3/themes/base/minified/jquery-ui.min.css" />

		<!-- PROGRESSBAR -->
		<script src="js/ocp/widget_progressbar.js"></script>
		<link rel="stylesheet" href="js/ocp/theme/default/widget_progressbar.css" />
		<!-- END PROGRESSBAR -->

		<!-- POOL VIEW -->
		<script src="js/ocp/widget_pool_view.js"></script>
		<link rel="stylesheet" href="js/ocp/theme/default/widget_pool_view.css" />
		<!-- END POOL VIEW -->

		<script src="_ext/FileSaver.js"></script>
		<script src="_ext/Blob.js"></script>

		<script src="js/ocp.js"></script>
		<script src="js/ocp_storage.js"></script>
		<script src="js/ocp_worker_ui.js"></script>
		<script src="js/ocp_worker_ui_pool.js"></script>
	</head>

	<body>
		<div id="pool_view"></div>
		Serveur URL: <input type="text" id="server_uri" value="" /><br/>
		Secret key: <input type="text" id="secret_key" value="toto" /><br/>
		<input type="file" id="file" name="file" /><button id="send">Send</button>
		<div id="progress" class="progress" style="position: relative; width: 200px; height: 50px;"></div>
		Upload name: <div id="upload_name"></div>

		<script>
$(document).ready(function() {
	$('#server_uri').val(ocp.cfg.server_base_url);
	$('.progress').ocp_progressbar();
	$('#pool_view').ocp_pool_view();

	$('#send').click(function() {
		ocp.cfg.server_base_url = $('#server_uri').val();
		var file = $('#file').get(0).files[0];
		if (!file) {
			alert('no file');
			return;
		}
		var args = {
			file: file,
			secret_key: $('#secret_key').val(),
			progress_bar: $('#progress'),
			pool_view: $('#pool_view')
		}

		file_upload(args);
	});
});

function file_upload(args) {
	var file = args.file;
	var secret_key = args.secret_key;
	var progress_bar = args.progress_bar;
	var total_task = 1;
	var total_performed = 0;
	var url = ocp.worker_ui.getURL('js/worker/ocp_upload.js');
	var pool = new ocp.worker_ui.pool.Pool(10, url);
	var cursor = 0;
	var block_size = 1 << 16;
	var hat_worker = new Hat();
	var block_id = 0;


	if (args.pool_view) {
		args.pool_view.ocp_pool_view('attach', pool);
	}

	while (cursor < file.size) {
		var cursor_next = cursor + block_size;

		var args = {
			file: file,
			cursor: cursor,
			cursor_next: cursor_next,
			block_id: block_id,
			secret_key: secret_key,
			server_uri: ocp.cfg.server_base_url
		};

		var callback_func = function(event) {
			console.log(event.data);
			check_error(event.data);
			var progress = update_progress_from_task(event.data);
			progress_bar.ocp_progressbar('set_progress', progress);
			if (event.data.filename) {
				hat_worker.push(event.data);
			}
		};

		var task = new ocp.worker_ui.pool.Task(block_id, 'upload_block', args, callback_func);
		pool.addTask(task);
		total_task++;

		cursor = cursor_next;
		block_id++;
	}

	function Hat() {
		var hat_callback = function() {
			console.log(event.data);
			check_error(event.data);
			var progress = update_progress_from_task(event.data);
			progress_bar.ocp_progressbar('set_progress', progress);
			if (event.data.filename) {
				$('#upload_name').html(event.data.filename);
			}
			pool.terminate();
		};

		var hat_args = {
			file: file,
			block_size: block_size,
			server_uri: ocp.cfg.server_base_url,
			secret_key: secret_key,
			message: 'init'
		};

		var task = new ocp.worker_ui.pool.Task('hat', 'upload_hat', hat_args, hat_callback);
		pool.addTask(task);

		this.push = function(data) {
			console.log('push');
			console.log(data);
			task.sendMessage('push', {
				filename: data.filename,
				block_id: data.block_id
			});
		};
	}

	function update_progress_from_task(obj) {
		if (total_task <= 0) {
			return 100;
		}
		if (obj.finish) {
			total_performed++;
		}
		return Math.floor(total_performed * 100 / total_task);
	}

	function check_error(data) {
		if (!data.exception) {
			return;
		}
		var e = new Error(data.exception);
		console.log('e=');
		console.log(e);
		console.log(e.stack);
		console.log(e.toString());
		pool.terminate(true);
		throw e;
	}
}
		</script>
	</body>
</html>