<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<base href="../.." />
		<script type="text/javascript" src="_ext/seedrandom-min.js"></script>
		<script type="text/javascript" src="_ext/d3.v3.min.js"></script>
		<script src="_ext/jquery-1.10.2.min.js"></script>

		<script src="js/ocp.js"></script>
		<script src="js/ocp_storage.js"></script>
		<script src="js/ocp_utils.js"></script>
		<script src="js/ocp_client.js"></script>
		<script src="js/ocp_math.js"></script>

		<script src="js/ocp_graphic.js"></script>
		<link rel="stylesheet" href="css/ocp_graphic.css" />


		<script src="js/ocp_worker_ui.js"></script>
		<script src="js/ocp_worker_ui_pool.js"></script>

		<style>

body, html {
	margin: 0;
	padding: 0;
	background-color: #F5F5F5;
	font-family: sans-serif;
}

#graph {
	display: block;
	overflow: hidden;
}

#svg {
	display: inline-block;
	vertical-align: top;
}

#buttons {
	display: inline-block;
	width: 180px;

	padding: 0px;
	margin: 0px;
	margin-top: 30px;

	list-style: none;
	vertical-align: top;
}

#buttons li {
	margin: 10px;
	padding: 5px 20px;

	border: 1px solid #CCCCCC;
	cursor: pointer;
	display: block;
	font-size: 14px;
	padding-left: 35px;
	color: #555555;
}

#buttons li:last-child {
	margin-top: 50px;
}

#buttons li:hover {
	background-color: #EEEEEE;
}

#legend {
	position: absolute;
	display: inline-block;
	font-size: 10px;

	background-color: rgba(255, 255, 255, 0.7);
}

#legend tr {
	height: 20px;
}

#legend td {
	vertical-align: middle;
}

.legend_color_box > div {
	width: 13px;
	height: 10px;
	padding: 2px;

	border: 1px solid #CCCCCC;
}

.legend_color {
	width: 100%;
	height: 100%;
}
		</style>
	</head>
	<body>
		<div id="graph">
			<svg id="svg" width="760" height="300"></svg>
			<ul id="buttons">
				<li id="48h">48 hours</li>
				<li id="1m">1 month</li>
				<li id="6m">6 months</li>
				<li id="1y">1 year</li>
				<li id="reset">Reset zoom</li>
			</ul>
		</div>

		<div id="legend">
			<table>
				<tr class="jqplot-table-legend">
					<td class="legend_color_box">
						<div>
							<div class="legend_color" style="background-color: #999999; border-color: #999999;"></div>
						</div>
					</td>
					<td>
						Transaction scatter plot
					</td>
				</tr>
				<tr class="jqplot-table-legend">
					<td class="legend_color_box">
						<div>
							<div class="legend_color" style="background-color: blue; border-color: blue;"></div>
						</div>
					</td>
					<td>
						OCP Storage share (3 last hours avg.)
					</td>
				</tr>
				<tr>
					<td class="legend_color_box">
						<div>
							<div class="legend_color" style="background-color: red; border-color: red;"></div>
						</div>
					</td>
					<td>
						OCP Storage share (12 last hours avg.)
					</td>
				</tr>
			</table>
		</div>
		<script>
var margin = { top: 5, right: 5, bottom: 20, left: 50 };

function print_48h() {
	var now_t = (new Date()).getTime() / 1000;
	var data = {
		start_t: now_t - 2 * 86400,
		end_t: now_t
	};
	var result = ocp.client.command(data, ocp.cfg.server_base_url + '/webocp/server/test/endpoint/get_transactions.php');
	var svg_elem = $('svg').get(0);

	ocp.graphic.draw_chart(svg_elem, result, margin);
}

function print_1m() {
	var now = new Date();
	var start = new Date(now.getTime());
	start.setMonth(start.getMonth() - 1);
	start.setHours(0, 0, 0, 0);
	var start_t = start.getTime() / 1000;
	var end_t = now.setHours(0, 0, 0, 0) / 1000;

	draw_graph(start_t, end_t, 1);
}

function print_6m() {
	var now = new Date();
	var start = new Date(now.getTime());
	start.setMonth(start.getMonth() - 6);
	start.setHours(0, 0, 0, 0);
	var start_t = start.getTime() / 1000;
	var end_t = now.setHours(0, 0, 0, 0) / 1000;

	draw_graph(start_t, end_t, 4);
}

function print_1y() {
	var now = new Date();
	var start = new Date(now.getTime());
	start.setMonth(start.getMonth() - 12);
	start.setHours(0, 0, 0, 0);
	var start_t = start.getTime() / 1000;
	var end_t = now.setHours(0, 0, 0, 0) / 1000;

	draw_graph(start_t, end_t, 10);
}

function draw_graph(start_t, end_t, group_size) {
	var data = {
		start_t: start_t,
		end_t: end_t
	};
	var result = ocp.client.command(data, ocp.cfg.server_base_url + '/webocp/server/test/endpoint/get_rate.php');
	var svg_elem = $('svg').get(0);
	result.transaction_list = ocp.graphic.group_transaction(result.transaction_list, group_size);
	ocp.graphic.draw_graph(svg_elem, result, start_t, end_t, margin);
}

function manage_legend() {
	var legend_on = $('#48h').hasClass('active');
	if (!legend_on) {
		$('#legend').hide();
		return;
	}
	$('#legend').show();
	var svg_offset = $('svg').offset();
	var offset = {
		top: 0 + $('svg').attr('height') - $('#legend').outerHeight(true) - margin.bottom - 1,
		left: 0 + $('svg').attr('width') - $('#legend').outerWidth(true) - margin.right - 1
	};
	$('#legend').offset(offset);
}

function svg_clean() {
	$('svg').children().remove();
}

$(document).ready(function() {
	$('#48h').click();
})

$('#buttons li').click(function() {
	$('#buttons li.active').removeClass('active');
	$(this).addClass('active');
	svg_clean();
	switch($(this).attr('id')) {
		case '48h':
			print_48h();
			break;
		case '1m':
			print_1m();
			break;
		case '6m':
			print_6m();
			break;
		case '1y':
			print_1y();
			break;
	}
	manage_legend();
});
		</script>
	</body>
</html>