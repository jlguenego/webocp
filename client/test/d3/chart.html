<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<base href="../.." />
		<script type="text/javascript" src="_ext/seedrandom-min.js"></script>
		<script type="text/javascript" src="_ext/d3.v3.min.js"></script>
		<script src="_ext/jquery-1.10.2.min.js"></script>

		<script src="js/ocp.js"></script>
		<script src="js/ocp_storage.js"></script>
		<script src="js/ocp_utils.js"></script>
		<script src="js/ocp_client.js"></script>


		<script src="js/ocp_worker_ui.js"></script>
		<script src="js/ocp_worker_ui_pool.js"></script>

		<style>

body, html {
	margin: 0;
	padding: 0;
	background-color: #EEEEEE;
}

svg {
	background-color: white;
    cursor: crosshair;
}

.point .circle {
	fill: none;
    stroke-width: 1.5px;
    stroke: #999999;
}

.point .shadow {
	fill: none;
    stroke-width: 1.5px;
    stroke: #DDDDDD;
}

.point .text {
	display: none;
}

.tooltip text {
	font-family: sans-serif;
    font-size: 11px;
    fill: #555555;
	text-anchor: start;
}

.tooltip rect {
	fill: rgba(167, 167, 167, 0.3);
	stroke-width: 0.1px;
	stroke: #000000;
}

.axis path {
    fill: none;
    stroke-width: 2px;
    stroke: #AAAAAA;
    shape-rendering: crispEdges;
}

.axis line {
    fill: none;
    stroke: #EEEEEE;
    shape-rendering: crispEdges;
}

.axis text {
    font-family: sans-serif;
    font-size: 11px;
}

		</style>
	</head>
	<body>
		<script>

var now_t = (new Date()).getTime() / 1000;
var yesterday_t = now_t - 86400;

function filter_transaction(dataset) {
	var result = [];
	for (var i = 0; i < dataset.length; i++) {
		var data = dataset[i];
		if (data.timestamp > yesterday_t && data.timestamp < now_t) {
			result.push(data);
		}
	}
	return result;
}


var result = ocp.client.command({}, ocp.cfg.server_base_url + '/webocp/server/test/endpoint/get_transactions.php');
var dataset = filter_transaction(result);
console.log(dataset);

var y_a = dataset.map(function(d) { return d.rate; });

var y_max = y_a.max() + 1;
var y_min = y_a.min() - 1;

var width = 600;
var height = 200;

var margin = { top: 50, right: 50, bottom: 50, left: 50 };
var svg = d3.select('body').append('svg')
	.attr('width', width + margin.left + margin.right)
	.attr('height', height + margin.top + margin.bottom);

function tooltip(g, msg, x, y, margin) {
	margin = margin || {top: 0, right: 3, bottom: 0, left: 3};
	g.classed('tooltip', true);

	var rect = g.append('rect')


	var text = g.append('text')
		.text(msg)
		.classed('label', true);
	text.attr('x', x + margin.left)
		.attr('y', y + margin.bottom);

	var r = text.node().getBBox();

	rect.attr('x', 	r.x - margin.left)
		.attr('y', r.y - margin.bottom)
		.attr('width', r.width + margin.left + margin.right)
		.attr('height', r.height + margin.top + margin.bottom);


}

var x_scale = d3.time.scale()
	.domain([ new Date(yesterday_t * 1000), new Date(now_t * 1000) ])
	.range([margin.left, margin.left + width ]);
var time_format = d3.time.format("%H:%M");
var x_axis = d3.svg.axis()
	.scale(x_scale)
	.orient("top")
	.tickSize(height)
	.ticks(d3.time.hour, 3)
	.tickFormat(time_format);

var y_scale = d3.scale.linear()
	.domain([ y_max, y_min ])
	.range([ margin.top, margin.top + height ]);
var eur_format = function(n) { return d3.format(".2f")(n) + ' â‚¬'; };
var y_axis = d3.svg.axis()
	.scale(y_scale)
	.orient("left")
	.tickSize(width)
	.ticks(5)
	.tickFormat(eur_format);

svg.append("g")
	.classed('axis', true)
	.attr("transform", 'translate(0, ' + (margin.top + height) + ')')
	.call(x_axis);

svg.append("g")
	.classed('axis', true)
	.attr("transform", 'translate(' + (margin.left + width) + ', 0)')
	.call(y_axis);

function translate(d) {
	return 'translate(' + x_scale(new Date(d.timestamp * 1000))
		+ ', ' + y_scale(d.rate) + ')';
}

function label(d) {
	return time_format(new Date(d.timestamp * 1000)) + ' ' + eur_format(d.rate);
}

var point = svg.selectAll('.point').data(dataset);
point.enter()
	.append('g')
		.attr('transform', translate)
		.classed('point', true);

point.append('circle')
		.attr('r', 2.5)
		.attr('cx', 1)
		.attr('cy', 1)
		.classed('shadow', true);

point.append('circle')
		.attr('r', 2.5)
		.classed('circle', true);

point
	.attr('cx', function(d) { return x_scale(new Date(d.timestamp * 1000)); })
	.attr('cy', function(d) { return y_scale(d.rate); });

point.exit().remove();

point.on('mouseover', function(e) {
	console.log(svg.node());
	var mouse = d3.mouse(svg.node());

	var p = d3.select(this);
	var transaction = p.datum();
	console.log(transaction);
	console.log(p);
	var info_dataset = [ transaction ];
	var info = svg.selectAll('.tooltip').data(info_dataset);
	info.enter().append('g');

	var msg = time_format(new Date(transaction.timestamp * 1000)) + ' ' + eur_format(transaction.rate);

	tooltip(info, msg, mouse[0] + 5, mouse[1] - 5);

	info.exit().remove();
});

point.on('mouseout', function(e) {
	var info = svg.selectAll('.tooltip').data([]);
	info.exit().remove();
});
		</script>
	</body>
</html>