<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<base href="../.." ></base>

		<!--[if IE]><script type="text/javascript">
		    // Fix for IE ignoring relative base tags.
		    (function() {
		        var bt = document.getElementsByTagName('base')[0];
		        bt.href = bt.href;
		    })();
		</script><![endif]-->
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
		<script type="text/javascript" src="_ext/d3.v3.min.js"></script>
		<script src="_ext/jquery-1.10.2.min.js"></script>

		<script src="js/ocp.js"></script>
		<script src="js/ocp/core.js"></script>
		<script src="js/ocp_worker_ui.js"></script>
		<script src="js/ocp_worker_ui_pool.js"></script>
		<script src="js/ocp_client.js"></script>
		<script src="js/ocp_dht.js"></script>
		<script src="js/ocp_storage.js"></script>
		<script src="js/visual/NodeMap.js"></script>
		<script src="js/visual/Pie.js"></script>
		<script src="js/ocp_utils.js"></script>

		<link rel="stylesheet" href="js/ocp/theme/default/core.css" />
		<link rel="stylesheet" href="css/main.css" />

		<script src="_ext/jquery-ui-1.10.3/ui/minified/jquery-ui.min.js"></script>
		<link rel="stylesheet" href="_ext/jquery-ui-1.10.3/themes/base/minified/jquery-ui.min.css" />
		<script src="js/ocp/widget_splitpane_h.js"></script>
		<link rel="stylesheet" href="js/ocp/theme/default/widget_splitpane_h.css" />
		<script src="js/ocp/widget_fix_variable_v.js"></script>

		<style type="text/css">

html, body {
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}

#view_node {

}

#map {
  width: 100%;
  height: 100%;
}

.ocp_node_map svg {
	position: absolute;
}

.ocp_node_map .node {
	cursor: pointer;
	fill: #EEEEEE;
	stroke: #AAAAAA;
	stroke-width: 3px;
}

.ocp_node_map .transparent_node {
	fill: none;
}

#node_prop {
	min-width: 450px;
}

#node_prop .title {
	height: 30px;
}

#node_prop .content {
	overflow: auto;
}

#view_node {
	height: 100%;
}

#pie .used {
	fill: #FF0000;
}
#pie .free {
	fill: #FFFF00;
}

#pie g {
	pointer-events: all;
}
		</style>
	</head>

	<body>
		<div id="view_node">
			<div id="node_prop">
				<div class="page_title">Node Properties</div>
				<div class="content">
					<div class="properties">
						<table>
							<tr>
								<td>Node name</td>
								<td class="name"></td>
							</tr>
							<tr>
								<td>Start address</td>
								<td class="start_address"></td>
							</tr>
							<tr>
								<td>Url</td>
								<td class="url"></td>
							</tr>
							<tr>
								<td>Quota</td>
								<td class="quota"></td>
							</tr>
							<tr>
								<td>Pie</td>
								<td><div id="pie"></div></td>
							</tr>
						</table>
					</div>
					<div class="buttons">
						<button id="refresh">Refresh</button>
					</div>
				</div>
			</div>
			<div id="map_view">
				<div id="map"></div>
			</div>
		</div>

		<script type="text/javascript">
$(document).ready(function() {
	$("#view_node").ocp_splitpane_h({
		source: [
			{ width: 450, }
		]
	});

	$('#node_prop').ocp_fix_variable();
	$('#node_prop .content').ocp_fix_variable({fix: $('#node_prop .content .buttons'), variable: $('#node_prop .content table')});

	var node_map = new ocp.visual.NodeMap();
	node_map.draw('#map');

	pie = new ocp.visual.Pie('#pie');
	pie.use_title = true;

	node_map.onnodeclick = function(node) {
		var node_prop = $('#node_prop');
		node_prop.find('.name').html(node.name);
		node_prop.find('.start_address').html(node.start_address);
		node_prop.find('.url').html(node.url);
		node_prop.find('.quota').html(ocp.utils.format_size(node.quota * 1000 * 1000 * 1000));

		var json = ocp.client.command({}, node.url + '/endpoint/get_mem_report.php');
		console.log(json);
		var used = json.used;
		var left = json.total - used;
		var data = [
			{"label": "used", "value": used, title: 'Used: ' + ocp.utils.format_size(used)}
		];
		if (used < json.total) {
			data.push({"label": "free", "value": left, title: 'Free: ' + ocp.utils.format_size(left)});
		}

		pie.set(data);

		console.log(node);
	};

	$('#refresh').click(function() {
		var url = ocp.cfg.server_base_url + '/webocp/server/node0';

		var url = ocp.dht.get_endpoint_url({url: url}, 'get_contact_list');
		var contact_list = ocp.client.command({}, url);
		console.log(contact_list);
		node_map.data = d3.values(contact_list)
			.filter(function(d) {
				return d.location instanceof Array;
			});
		node_map.repaint();
	});
});
    </script>
  </body>
</html>